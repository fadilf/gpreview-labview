<script>
    if (typeof rawData === 'undefined') {
        var rawData = { "Structure to Diagram": [], "Diagram to Structure": [], "FP": { "Bounds": { "Width": 0, "Height": 0 }, "Position": { "Left": 0, "Top": 0 }, "Image": "" }, "BD": { "Bounds": { "Width": 73, "Height": 20 }, "Position": { "Left": 128, "Top": 125 }, "Color": "FFFFFF", "Image": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEkAAAAUCAMAAAD2veDHAAADAFBMVEX//////8z//5n//2b//zP//wD/zP//zMz/zJn/zGb/zDP/zAD/mf//mcz/mZn/mWb/mTP/mQD/Zv//Zsz/Zpn/Zmb/ZjP/ZgD/M///M8z/M5n/M2b/MzP/MwD/AP//AMz/AJn/AGb/ADP/AADM///M/8zM/5nM/2bM/zPM/wDMzP/MzMzMzJnMzGbMzDPMzADMmf/MmczMmZnMmWbMmTPMmQDMZv/MZszMZpnMZmbMZjPMZgDMM//MM8zMM5nMM2bMMzPMMwDMAP/MAMzMAJnMAGbMADPMAACZ//+Z/8yZ/5mZ/2aZ/zOZ/wCZzP+ZzMyZzJmZzGaZzDOZzACZmf+ZmcyZmZmZmWaZmTOZmQCZZv+ZZsyZZpmZZmaZZjOZZgCZM/+ZM8yZM5mZM2aZMzOZMwCZAP+ZAMyZAJmZAGaZADOZAABm//9m/8xm/5lm/2Zm/zNm/wBmzP9mzMxmzJlmzGZmzDNmzABmmf9mmcxmmZlmmWZmmTNmmQBmZv9mZsxmZplmZmZmZjNmZgBmM/9mM8xmM5lmM2ZmMzNmMwBmAP9mAMxmAJlmAGZmADNmAAAz//8z/8wz/5kz/2Yz/zMz/wAzzP8zzMwzzJkzzGYzzDMzzAAzmf8zmcwzmZkzmWYzmTMzmQAzZv8zZswzZpkzZmYzZjMzZgAzM/8zM8wzM5kzM2YzMzMzMwAzAP8zAMwzAJkzAGYzADMzAAAA//8A/8wA/5kA/2YA/zMA/wAAzP8AzMwAzJkAzGYAzDMAzAAAmf8AmcwAmZkAmWYAmTMAmQAAZv8AZswAZpkAZmYAZjMAZgAAM/8AM8wAM5kAM2YAMzMAMwAAAP8AAMwAAJkAAGYAADPuAADdAAC7AACqAACIAAB3AABVAABEAAAiAAARAAAA7gAA3QAAuwAAqgAAiAAAdwAAVQAARAAAIgAAEQAAAO4AAN0AALsAAKoAAIgAAHcAAFUAAEQAACIAABHu7u7d3d27u7uqqqqIiIh3d3dVVVVEREQiIiIREREAAAD7CIKZAAAA+ElEQVR4nOWUzQ2DMAyFgVsGyQbcGCLqDjBBOkQvwASoA0APlCW4cWMcXNtxVYLIoagXVAsFyzEffo+fqIPD0UVeQHw44AykpB6xnFTm05M1uKgxKbUUvN0wqXrYTa8idmZ3SOu2HdKl1RtSj4VSf08yqIZa1ABguamwNJeQsHzH3QxgTGpcOAuQ5Kjx+iffM21QnJConM7GDSQz8WmPRO5WhjQRgMZodW6EpES7ApgdibMAKS6uHinO2bs1iXZzJrksRFLD7NT1zuQU8EXw1KlJo3QmcRYisRNo7SyPhlvfjgM7XsB0I99Hyc7xtfyKtBz/Py3R/8QL3EYGaT4V94EAAAAASUVORK5CYII=" } }
    }
</script>
<div class="borders">
    <div class="border border-top"></div>
    <div class="border border-bottom"></div>
    <div class="border border-left"></div>
    <div class="border border-right"></div>
</div>
<div id="tab-container" data-tab="fp">
    <div id="switcher"><button data-tab-select="fp">FP</button><button data-tab-select="bd">BD</button></div>
    <div id="fp-container"></div>
    <div id="bd-container">
        <div id="top-level-diagram"></div>
    </div>
</div>
<script>
    $fpContainer = document.querySelector("#fp-container");
    if (rawData["FP"]["Image"] === "") {
        $fpContainer.innerHTML = "Front Panel is empty"
    } else {
        $fpContainer.style.backgroundImage = `url(${rawData["FP"]["Image"]})`;
        $fpContainer.style.height = rawData["FP"]["Bounds"]["Height"] + "px";
        $fpContainer.style.width = rawData["FP"]["Bounds"]["Width"] + "px";
    }

    let structureMap = {}
    rawData["Structure to Diagram"].forEach(item => {
        structureMap[item.UID] = item["Diagram Group"]
    })
    let diagramMap = {}
    rawData["Diagram to Structure"].forEach(item => {
        diagramMap[item["Diagram UID"]] = item["Diagram Children"]
    })

    let structures = [];
    function traverseDiagram(diagramUID, parentPosition) {
        if (diagramUID in diagramMap) {
            return diagramMap[diagramUID].map(structureUID => traverseStructure(structureUID, parentPosition))
        } else {
            return []
        }
    }
    function traverseStructure(structureUID, parentPosition) {
        let structureData = structureMap[structureUID];
        let diagrams = []
        let currentPosition = {
            "top": structureData["Position"]["Top"],
            "left": structureData["Position"]["Left"]
        }
        structureData["Diagram Data"].forEach(diagram => {
            diagrams.push({
                "image": diagram["Diagram Image"],
                "structures": traverseDiagram(diagram["UID"], currentPosition)
            })
        })
        return {
            "top": structureData["Position"]["Top"] - parentPosition["top"],
            "left": structureData["Position"]["Left"] - parentPosition["left"],
            "width": structureData["Bounds"]["Width"],
            "height": structureData["Bounds"]["Height"],
            "diagrams": diagrams
        }
    }
    rawData["Structure to Diagram"].forEach(item => {
        let structureUID = item["UID"];
        if (item["Diagram Group"]["Is on TLD?"]) {
            structures.push(traverseStructure(structureUID, { "top": 0, "left": 0 }))
        }
    })

    function printStructures(structures) {
        let output = "";
        structures.forEach((structure) => {
            output += `<div class="structure" 
                style="top:${structure.top}px; left:${structure.left}px; width:${structure.width}px; height:${structure.height}px" 
                data-diagrams="${structure.diagrams.length}"
                data-index="0">`;
            structure.diagrams.forEach((diagram, index) => {
                output += `<div class="diagram${(index == 0) ? ' visible' : ''}" 
                    style="background-image:url(${diagram.image}); width:${structure.width}px; height:${structure.height}px">`;
                output += printStructures(diagram.structures);
                output += '</div>';
            });
            output += `</div>`;
        });
        return output;
    }

    $bdContainer = document.querySelector("#bd-container")
    if (rawData["BD"]["Image"] === "") {
        let output = "Block Diagram is empty";
        $bdContainer.innerHTML = output;

    } else {
        let bgLeft = rawData["BD"]["Position"]["Left"];
        let bgTop = rawData["BD"]["Position"]["Top"];
        let bgWidth = rawData["BD"]["Bounds"]["Width"];
        let bgHeight = rawData["BD"]["Bounds"]["Height"];
        let output = `<div style="left:${bgLeft}px;top:${bgTop}px;width:${bgWidth}px;height:${bgHeight}px;background-image:url(${rawData["BD"]["Image"]})"></div>` + printStructures(structures);
        document.querySelector("#top-level-diagram").innerHTML = output;
        if (bgLeft < 0) {
            $bdContainer.style.left = (bgLeft * -1) + "px";
        }
        if (bgTop < 0) {
            $bdContainer.style.top = (bgTop * -1) + "px";
        }
    }
    document.body.style.backgroundColor = "#" + rawData["BD"]["Color"];


    document.querySelectorAll(".structure").forEach(structureElem => {
        structureElem.addEventListener("click", (event) => {
            event.stopPropagation()
            let diagrams = parseInt(structureElem.getAttribute("data-diagrams"));
            let oldIndex = parseInt(structureElem.getAttribute("data-index"));
            let newIndex = (oldIndex + 1) % diagrams;
            structureElem.children[oldIndex].classList.remove("visible")
            structureElem.children[newIndex].classList.add("visible")
            structureElem.setAttribute("data-index", newIndex)
        });
    })

    let $tabContainer = document.getElementById("tab-container");
    document.querySelectorAll("#switcher button").forEach($btn => {
        $btn.addEventListener("click", () => {
            let tabSelect = $btn.getAttribute("data-tab-select");
            console.log($btn);
            $tabContainer.setAttribute("data-tab", tabSelect)
        });
    })

</script>
<style>
    .structure {
        position: absolute;
        overflow-y: hidden;
        cursor: pointer;
    }

    .diagram {
        display: none;
    }

    .diagram.visible {
        display: block;
    }

    .structure:hover {
        box-shadow: 2px 2px 8px -4px #000;
        transition: 0.2s;
    }

    #top-level-diagram {
        position: absolute;
        top: 0;
        left: 0;
    }

    #top-level-diagram>div {
        position: absolute;
    }

    #bd-container {
        position: absolute;
    }

    #switcher {
        position: fixed;
        left: 10px;
        bottom: 10px;
        background-color: #c8c8c8d4;
        border-radius: 5px;
        z-index: 100;
    }

    #switcher::before {
        content: "";
        display: block;
        width: 40px;
        height: 32px;
        position: absolute;
        box-sizing: border-box;
        border: 2px solid #333;
        border-radius: 5px;
        transition: .3s;
        left: 0;
    }

    #switcher button {
        box-sizing: border-box;
        border: 0;
        background-color: transparent;
        padding: 5px 7px;
        font-size: 15px;
        line-height: 23px;
        display: inline-block;
        height: 32px;
        width: 40px;
        cursor: pointer;
    }

    #fp-container,
    #bd-container {
        display: none;
    }

    #tab-container {
        color: #292929;
    }

    #tab-container[data-tab=fp] #fp-container {
        display: block;
    }

    #tab-container[data-tab=bd] #bd-container {
        display: block;
    }

    #tab-container[data-tab=bd] #switcher::before {
        left: 40px;
    }
    
    .border {
        position: fixed;
        z-index: 100;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        width: 100%;
        height: 100%;
        background-color: #333;
    }

    .border-top {
        height: 1px;
        bottom: auto;
    }

    .border-left {
        width: 1px;
        right: auto;
    }

    .border-bottom {
        height: 1px;
        top: auto;
    }

    .border-right {
        width: 1px;
        left: auto;
    }
</style>
</body>

</html>